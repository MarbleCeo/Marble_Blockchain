{% extends "base.html" %}

{% block title %}DEX Trading - Marble Blockchain{% endblock %}

{% block extra_css %}
<!-- Chart.js for price charts -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2/dist/chartjs-plugin-annotation.min.css">
<style>
    .order-card {
        font-size: 0.9rem;
    }
    
    .green-text {
        color: var(--success-color);
    }
    
    .red-text {
        color: var(--danger-color);
    }
    
    .orderbook-row {
        font-size: 0.85rem;
        cursor: pointer;
        padding: 2px 8px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .orderbook-row:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    .buy-order {
        background-color: rgba(15, 157, 88, 0.1);
    }
    
    .sell-order {
        background-color: rgba(219, 68, 55, 0.1);
    }
    
    .price-chart-container {
        height: 400px;
        position: relative;
    }
    
    .price-info {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 8px 12px;
        border-radius: 5px;
        font-weight: 500;
        z-index: 10;
    }
    
    /* Trading form styles */
    .nav-pills .nav-link.active {
        background-color: var(--primary-color);
    }
    
    .price-input-group {
        position: relative;
    }
    
    .price-unit {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        font-size: 0.9rem;
        pointer-events: none;
    }
    
    .volume-slider {
        width: 100%;
    }
    
    /* Trade history */
    .trade-history {
        max-height: 600px;
        overflow-y: auto;
    }
    
    .trade-history-item {
        border-left: 3px solid transparent;
        transition: all 0.2s;
    }
    
    .trade-history-item.buy {
        border-left-color: var(--success-color);
    }
    
    .trade-history-item.sell {
        border-left-color: var(--danger-color);
    }
    
    .trade-history-item:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
    
    /* Market pairs */
    .market-pair {
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .market-pair:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    .market-pair.active {
        background-color: rgba(26, 115, 232, 0.1);
        border-left: 3px solid var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid fade-in">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">DEX Trading</h2>
                <div>
                    <button class="btn btn-outline-secondary me-2" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        <i class="fas fa-cog me-1"></i> Settings
                    </button>
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#helpModal">
                        <i class="fas fa-question-circle me-1"></i> How to Trade
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Market Pairs Column -->
        <div class="col-md-2">
            <div class="card h-100">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Market Pairs</h5>
                        <button class="btn btn-sm btn-outline-secondary" id="refreshMarkets">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-2">
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control form-control-sm" id="marketSearch" placeholder="Search...">
                    </div>
                    
                    <div id="marketPairs" class="overflow-auto" style="max-height: 500px;">
                        <!-- Market pairs will be dynamically loaded here -->
                        {% for pair in market_pairs|default([]) %}
                        <div class="market-pair {% if pair.symbol == active_pair %}active{% endif %}" data-pair="{{ pair.symbol }}">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>{{ pair.base }}/{{ pair.quote }}</strong>
                                </div>
                                <div class="{% if pair.change >= 0 %}green-text{% else %}red-text{% endif %}">
                                    {{ pair.change|float|abs }}%
                                    <i class="fas fa-{% if pair.change >= 0 %}caret-up{% else %}caret-down{% endif %}"></i>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">{{ pair.price }}</small>
                                <small class="text-muted">Vol: {{ pair.volume }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chart Column -->
        <div class="col-md-7">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" id="pairTitle">{{ active_pair|default('MARBLE/USDC') }}</h5>
                        <div>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-secondary active" data-time="1h">1H</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-time="4h">4H</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-time="1d">1D</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-time="1w">1W</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-time="1m">1M</button>
                            </div>
                            <div class="btn-group ms-2" role="group">
                                <button type="button" class="btn btn-sm btn-outline-secondary active" data-chart="candle">Candle</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-chart="line">Line</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="price-chart-container">
                        <div class="price-info">
                            <div class="current-price">{{ current_price|default('0.00') }} <span class="text-muted">USDC</span></div>
                            <div class="price-change {% if price_change|default(0) >= 0 %}green-text{% else %}red-text{% endif %}">
                                {{ price_change|default(0)|abs }}%
                                <i class="fas fa-{% if price_change|default(0) >= 0 %}caret-up{% else %}caret-down{% endif %}"></i>
                            </div>
                        </div>
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Market Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card order-card">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">24h High</small>
                                <strong>{{ day_high|default('0.00') }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card order-card">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">24h Low</small>
                                <strong>{{ day_low|default('0.00') }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card order-card">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">24h Volume</small>
                                <strong>{{ day_volume|default('0.00') }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card order-card">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">24h Trades</small>
                                <strong>{{ day_trades|default('0') }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Trades -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Trades</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive trade-history">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Amount</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trade in recent_trades|default([]) %}
                                <tr class="trade-history-item {{ trade.type }}">
                                    <td>{{ trade.time }}</td>
                                    <td class="{% if trade.type == 'buy' %}green-text{% else %}red-text{% endif %}">
                                        {{ trade.type|upper }}
                                    </td>
                                    <td>{{ trade.price }}</td>
                                    <td>{{ trade.amount }}</td>
                                    <td>{{ trade.total }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Orderbook and Trade Form Column -->
        <div class="col-md-3">
            <!-- Orderbook -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Orderbook</h5>
                </div>
                <div class="card-body p-0">
                    <!-- Sell Orders (reversed) -->
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Price</th>
                                    <th>Amount</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="sellOrders">
                                {% for order in sell_orders|default([]) %}
                                <tr class="orderbook-row sell-order" data-price="{{ order.price }}" data-amount="{{ order.amount }}">
                                    <td class="red-text">{{ order.price }}</td>
                                    <td>{{ order.amount }}</td>
                                    <td>{{ order.total }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Current Price -->
                    <div class="p-2 text-center" style="background-color: #f8f9fa; border-top: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6;">
                        <h5 class="mb-0">{{ current_price|default('0.00') }} <small class="text-muted">USDC</small></h5>
                    </div>
                    
                    <!-- Buy Orders -->
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Price</th>
                                    <th>Amount</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="buyOrders">
                                {% for order in buy_orders|default([]) %}
                                <tr class="orderbook-row buy-order" data-price="{{ order.price }}" data-amount="{{ order.amount }}">
                                    <td class="green-text">{{ order.price }}</td>
                                    <td>{{ order.amount }}</td>
                                    <td>{{ order.total }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Trading Form -->
            <div class="card mb-4">
                <div class="card-header">
                    <ul class="nav nav-pills card-header-pills" id="tradeTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="buy-tab" data-bs-toggle="pill" data-bs-target="#buy-form" type="button" role="tab">Buy</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="sell-tab" data-bs-toggle="pill" data-bs-target="#sell-form" type="button" role="tab">Sell</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="tradeTabContent">
                        <!-- Buy Form -->
                        <div class="tab-pane fade show active" id="buy-form" role="tabpanel">
                            <form id="buyForm" action="/api/order/buy" method="post">
                                <div class="mb-3">
                                    <label for="buyPrice" class="form-label">Price</label>
                                    <div class="price-input-group">
                                        <input type="number" class="form-control" id="buyPrice" name="price" step="0.0001" min="0" value="{{ current_price|default('0.00') }}">
                                        <span class="price-unit">USDC</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="buyAmount" class="form-label">Amount</label>
                                    <div class="price-input-group">
                                        <input type="number" class="form-control" id="buyAmount" name="amount" step="0.01" min="0">
                                        <span class="price-unit">{{ active_pair_base|default('MARBLE') }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="buyVolume" class="form-label">Total</label>
                                    <div class="price-input-group">
                                        <input type="number" class="form-control" id="buyTotal" name="total" step="0.01" min="0" readonly>
                                        <span class="price-unit">USDC</span>
                                    </div>
                                </div>
                                
                                <!-- Volume Slider -->
                                <div class="mb-3">
                                    <label class="form-label">Order Size</label>
                                    <input type="range" class="form-range volume-slider" id="buyVolumeSlider" min="0" max="100" value="0">
                                    <div class="d-flex justify-content-between">
                                        <small>0%</small>
                                        <small>25%</small>
                                        <small>50%</small>
                                        <small>75%</small>
                                        <small>100%</small>
                                    </div>
                                </div>
                                
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-shopping-cart me-2"></i>Buy {{ active_pair_base|default('MARBLE') }}
                                    </button>
                                </div>
                                
                                <div class="mt-3">
                                    <small class="text-muted">
                                        Available: <span id="buyAvailable">{{ available_quote|default('0.00') }}</span> USDC
                                    </small>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Sell Form -->
                        <div class="tab-pane fade" id="sell-form" role="tabpanel">
                            <form id="sellForm" action="/api/order/sell" method="post">
                                <div class="mb-3">
                                    <label for="sellPrice" class="form-label">Price</label>
                                    <div class="price-input-group">
                                        <input type="number" class="form-control" id="sellPrice" name="price" step="0.0001" min="0" value="{{ current_price|default('0.00') }}">
                                        <span class="price-unit">USDC</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="sellAmount" class="form-label">Amount</label>
                                    <div class="price-input-group">
                                        <input type="number" class="form-control" id="sellAmount" name="amount" step="0.01" min="0">
                                        <span class="price-unit">{{ active_pair_base|default('MARBLE') }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="sellTotal" class="form-label">Total</label>
                                    <div class="price-input-group">
                                        <input type="number" class="form-control" id="sellTotal" name="total" step="0.01" min="0" readonly>
                                        <span class="price-unit">USDC</span>
                                    </div>
                                </div>
                                
                                <!-- Volume Slider -->
                                <div class="mb-3">
                                    <label class="form-label">Order Size</label>
                                    <input type="range" class="form-range volume-slider" id="sellVolumeSlider" min="0" max="100" value="0">
                                    <div class="d-flex justify-content-between">
                                        <small>0%</small>
                                        <small>25%</small>
                                        <small>50%</small>
                                        <small>75%</small>
                                        <small>100%</small>
                                    </div>
                                </div>
                                
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-danger">
                                        <i class="fas fa-tag me-2"></i>Sell {{ active_pair_base|default('MARBLE') }}
                                    </button>
                                </div>
                                
                                <div class="mt-3">
                                    <small class="text-muted">
                                        Available: <span id="sellAvailable">{{ available_base|default('0.00') }}</span> {{ active_pair_base|default('MARBLE') }}
                                    </small>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Orders -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Open Orders</h5>
                </div>
                <div class="card-body p-0">
                    {% if active_orders|default([]) %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Price</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in active_orders %}
                                <tr>
                                    <td class="{% if order.type == 'buy' %}green-text{% else %}red-text{% endif %}">
                                        {{ order.type|upper }}
                                    </td>
                                    <td>{{ order.price }}</td>
                                    <td>
                                        {{ order.filled_amount }}/{{ order.amount }}
                                        <div class="progress" style="height: 4px;">
                                            <div class="progress-bar {% if order.type == 'buy' %}bg-success{% else %}bg-danger{% endif %}" 
                                                 style="width: {{ (order.filled_amount / order.amount * 100)|float }}%"></div>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger cancel-order" data-order-id="{{ order.id }}">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-clipboard-list mb-2" style="font-size: 2rem;"></i>
                        <p>No open orders</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Trading Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <div class="mb-3">
                        <label class="form-label">Chart Type</label>
                        <select class="form-select" id="chartTypeSelect">
                            <option value="candle">Candlestick</option>
                            <option value="line">Line</option>
                            <option value="bar">Bar</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Price Precision</label>
                        <select class="form-select" id="pricePrecisionSelect">
                            <option value="2">2 decimals</option>
                            <option value="4">4 decimals</option>
                            <option value="6">6 decimals</option>
                            <option value="8">8 decimals</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Order Confirmation</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="orderConfirmSwitch" checked>
                            <label class="form-check-label" for="orderConfirmSwitch">Confirm before placing orders</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chart Indicators</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="maIndicator" checked>
                            <label class="form-check-label" for="maIndicator">Moving Average</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="rsiIndicator">
                            <label class="form-check-label" for="rsiIndicator">RSI</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="bollingerIndicator">
                            <label class="form-check-label" for="bollingerIndicator">Bollinger Bands</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSettings">Save Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">How to Trade on Marble DEX</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6 class="fw-bold"><i class="fas fa-info-circle me-2 text-primary"></i>Overview</h6>
                    <p>Marble DEX is a decentralized exchange built on the Marble Blockchain. It allows you to trade tokens directly from your wallet without intermediaries.</p>
                </div>
                
                <div class="mb-4">
                    <h6 class="fw-bold"><i class="fas fa-wallet me-2 text-primary"></i>Connect Your Wallet</h6>
                    <p>To start trading, connect your Marble wallet by clicking the "Connect Wallet" button in the top right corner.</p>
                </div>
                
                <div class="mb-4">
                    <h6 class="fw-bold"><i class="fas fa-exchange-alt me-2 text-primary"></i>How to Trade</h6>
                    <ol>
                        <li>Select a trading pair from the left sidebar</li>
                        <li>Choose Buy or Sell tab in the order form</li>
                        <li>Enter the price and amount, or click on an order in the orderbook to auto-fill</li>
                        <li>Use the slider to quickly set a percentage of your available balance</li>
                        <li>Review your order and click the Buy/Sell button</li>
                        <li>Confirm the transaction in your wallet</li>
                    </ol>
                </div>
                
                <div class="mb-4">
                    <h6 class="fw-bold"><i class="fas fa-chart-line me-2 text-primary"></i>Reading the Chart</h6>
                    <p>The price chart shows historical price movements. You can:</p>
                    <ul>
                        <li>Change the timeframe using the buttons above the chart (1H, 4H, 1D, etc.)</li>
                        <li>Switch between candlestick and line chart views</li>
                        <li>Add technical indicators in the settings</li>
                    </ul>
                </div>
                
                <div class="mb-4">
                    <h6 class="fw-bold"><i class="fas fa-book me-2 text-primary"></i>Understanding the Orderbook</h6>
                    <p>The orderbook shows all open buy (green) and sell (red) orders:</p>
                    <ul>
                        <li><strong>Price</strong>: The price per token in USDC</li>
                        <li><strong>Amount</strong>: Number of tokens being bought/sold</li>
                        <li><strong>Total</strong>: Total value of the order (Price Ã— Amount)</li>
                    </ul>
                    <p class="text-muted small">Click on any order to use that price and amount in your trading form.</p>
                </div>
                
                <div class="mb-4">
                    <h6 class="fw-bold"><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Trading Fees</h6>
                    <p>Trading fees are currently set at 0.2% per trade and are automatically calculated in your order.</p>
                </div>
                
                <div>
                    <h6 class="fw-bold"><i class="fas fa-question-circle me-2 text-primary"></i>Need More Help?</h6>
                    <p>For more detailed guides and documentation, visit our <a href="https://docs.marbleblockchain.io" target="_blank">knowledge base</a> or join our <a href="https://discord.gg/marbleblockchain" target="_blank">Discord community</a>.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="https://docs.marbleblockchain.io/trading-guide" target="_blank" class="btn btn-primary">Detailed Trading Guide</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Chart.js for price charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@1.1.0-alpha/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
    // Initialize price chart
    const ctx = document.getElementById('priceChart').getContext('2d');
    let priceChart;
    
    // Sample data - in production this would come from the server
    const sampleData = {
        labels: Array.from({ length: 30 }, (_, i) => new Date(Date.now() - (29 - i) * 24 * 60 * 60 * 1000)),
        datasets: [{
            label: 'Price',
            data: [{{ price_data|default("16.2, 16.5, 16.3, 16.8, 17.1, 17.0, 16.9, 17.2, 17.3, 17.5, 17.6, 17.4, 17.3, 17.5, 17.8, 18.0, 18.2, 18.1, 18.3, 18.5, 18.4, 18.2, 18.0, 18.1, 18.3, 18.2, 18.0, 17.8, 17.9, 18.0") }}],
            backgroundColor: 'rgba(26, 115, 232, 0.1)',
            borderColor: 'rgba(26, 115, 232, 1)',
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: 'rgba(26, 115, 232, 1)',
            tension: 0.2
        }]
    };
    
    function initChart() {
        priceChart = new Chart(ctx, {
            type: 'line',
            data: sampleData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MMM d'
                            }
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    legend: {
                        display: false
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }
    
    // Initialize the chart when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initChart();
        
        // Set up event handlers for the buy form
        const buyPrice = document.getElementById('buyPrice');
        const buyAmount = document.getElementById('buyAmount');
        const buyTotal = document.getElementById('buyTotal');
        const buyVolumeSlider = document.getElementById('buyVolumeSlider');
        
        function updateBuyTotal() {
            if (buyPrice.value && buyAmount.value) {
                buyTotal.value = (parseFloat(buyPrice.value) * parseFloat(buyAmount.value)).toFixed(2);
            } else {
                buyTotal.value = '';
            }
        }
        
        buyPrice.addEventListener('input', updateBuyTotal);
        buyAmount.addEventListener('input', updateBuyTotal);
        
        buyVolumeSlider.addEventListener('input', function() {
            const percentage = parseFloat(this.value) / 100;
            const available = parseFloat(document.getElementById('buyAvailable').textContent);
            const price = parseFloat(buyPrice.value);
            
            if (!isNaN(available) && !isNaN(price) && price > 0) {
                const maxAmount = available / price;
                buyAmount.value = (maxAmount * percentage).toFixed(4);
                updateBuyTotal();
            }
        });
        
        // Set up event handlers for the sell form
        const sellPrice = document.getElementById('sellPrice');
        const sellAmount = document.getElementById('sellAmount');
        const sellTotal = document.getElementById('sellTotal');
        const sellVolumeSlider = document.getElementById('sellVolumeSlider');
        
        function updateSellTotal() {
            if (sellPrice.value && sellAmount.value) {
                sellTotal.value = (parseFloat(sellPrice.value) * parseFloat(sellAmount.value)).toFixed(2);
            } else {
                sellTotal.value = '';
            }
        }
        
        sellPrice.addEventListener('input', updateSellTotal);
        sellAmount.addEventListener('input', updateSellTotal);
        
        sellVolumeSlider.addEventListener('input', function() {
            const percentage = parseFloat(this.value) / 100;
            const available = parseFloat(document.getElementById('sellAvailable').textContent);
            
            if (!isNaN(available)) {
                sellAmount.value = (available * percentage).toFixed(4);
                updateSellTotal();
            }
        });
        
        // Click on orderbook row to fill order form
        document.querySelectorAll('.orderbook-row').forEach(row => {
            row.addEventListener('click', function() {
                const price = this.dataset.price;
                const amount = this.dataset.amount;
                
                // If this is a sell order, fill buy form
                if (this.classList.contains('sell-order')) {
                    buyPrice.value = price;
                    buyAmount.value = amount;
                    updateBuyTotal();
                    // Switch to buy tab
                    document.getElementById('buy-tab').click();
                } 
                // If this is a buy order, fill sell form
                else if (this.classList.contains('buy-order')) {
                    sellPrice.value = price;
                    sellAmount.value = amount;
                    updateSellTotal();
                    // Switch to sell tab
                    document.getElementById('sell-tab').click();
                }
            });
        });
        
        // Set up cancel order buttons
        document.querySelectorAll('.cancel-order').forEach(button => {
            button.addEventListener('click', function() {
                const orderId = this.dataset.orderId;
                
                if (confirm('Are you sure you want to cancel this order?')) {
                    // In a real implementation, this would make an API call
                    fetch(`/api/order/cancel/${orderId}`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Reload the page or update the UI
                            location.reload();
                        } else {
                            alert(`Failed to cancel order: ${data.error}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error cancelling order:', error);
                        alert('An error occurred while cancelling the order');
                    });
                }
            });
        });
        
        // Form submission handlers
        document.getElementById('buyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            const price = parseFloat(buyPrice.value);
            const amount = parseFloat(buyAmount.value);
            const total = parseFloat(buyTotal.value);
            
            // Validate inputs
            if (isNaN(price) || price <= 0) {
                alert('Please enter a valid price');
                return;
            }
            
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            // Check if user has confirmed (if enabled in settings)
            if (document.getElementById('orderConfirmSwitch').checked) {
                if (!confirm(`Confirm buy order: ${amount} tokens at ${price} USDC each for a total of ${total} USDC?`)) {
                    return;
            }
            
            // Submit the order
            fetch('/api/order/buy', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    pair: document.getElementById('pairTitle').textContent,
                    price: price,
                    amount: amount,
                    total: total
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.className = 'alert alert-success alert-dismissible fade show';
                    successAlert.innerHTML = `
                        <strong>Success!</strong> Your buy order has been placed.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.querySelector('.main-content').prepend(successAlert);
                    
                    // Reset form
                    buyAmount.value = '';
                    buyTotal.value = '';
                    buyVolumeSlider.value = 0;
                    
                    // Auto-dismiss after 5 seconds
                    setTimeout(() => {
                        const bsAlert = new bootstrap.Alert(successAlert);
                        bsAlert.close();
                    }, 5000);
                } else {
                    alert(`Failed to place order: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error placing order:', error);
                alert('An error occurred while placing the order');
            });
        });
        
        // Sell form submission handler
        document.getElementById('sellForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            const price = parseFloat(sellPrice.value);
            const amount = parseFloat(sellAmount.value);
            const total = parseFloat(sellTotal.value);
            
            // Validate inputs
            if (isNaN(price) || price <= 0) {
                alert('Please enter a valid price');
                return;
            }
            
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            // Check if user has confirmed (if enabled in settings)
            if (document.getElementById('orderConfirmSwitch').checked) {
                if (!confirm(`Confirm sell order: ${amount} tokens at ${price} USDC each for a total of ${total} USDC?`)) {
                    return;
                }
            }
            
            // Submit the order
            fetch('/api/order/sell', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    pair: document.getElementById('pairTitle').textContent,
                    price: price,
                    amount: amount,
                    total: total
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const successAlert = document.createElement('div');
                    successAlert.className = 'alert alert-success alert-dismissible fade show';
                    successAlert.innerHTML = `
                        <strong>Success!</strong> Your sell order has been placed.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.querySelector('.main-content').prepend(successAlert);
                    
                    // Reset form
                    sellAmount.value = '';
                    sellTotal.value = '';
                    sellVolumeSlider.value = 0;
                    
                    // Auto-dismiss after 5 seconds
                    setTimeout(() => {
                        const bsAlert = new bootstrap.Alert(successAlert);
                        bsAlert.close();
                    }, 5000);
                } else {
                    alert(`Failed to place order: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error placing order:', error);
                alert('An error occurred while placing the order');
            });
        });
        
        // Save settings
        document.getElementById('saveSettings').addEventListener('click', function() {
            // Get settings values
            const chartType = document.getElementById('chartTypeSelect').value;
            const precision = document.getElementById('pricePrecisionSelect').value;
            const confirmOrders = document.getElementById('orderConfirmSwitch').checked;
            const showMA = document.getElementById('maIndicator').checked;
            const showRSI = document.getElementById('rsiIndicator').checked;
            const showBollinger = document.getElementById('bollingerIndicator').checked;
            
            // Save to localStorage
            localStorage.setItem('marbleDEXSettings', JSON.stringify({
                chartType: chartType,
                precision: precision,
                confirmOrders: confirmOrders,
                indicators: {
                    ma: showMA,
                    rsi: showRSI,
                    bollinger: showBollinger
                }
            }));
            
            // Update chart
            if (priceChart) {
                priceChart.destroy();
                initChart();
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
            modal.hide();
            
            // Show confirmation
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3';
            toast.style.zIndex = 1050;
            toast.innerHTML = `
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <strong class="me-auto">Settings</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        Settings saved successfully.
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                const bsToast = bootstrap.Toast.getInstance(toast.querySelector('.toast'));
                if (bsToast) bsToast.hide();
                else toast.remove();
            }, 3000);
        });
        
        // Set up WebSocket for real-time updates
        function setupWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/market`;
            
            const ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connection established');
                
                // Subscribe to the active trading pair
                const activePair = document.getElementById('pairTitle').textContent;
                ws.send(JSON.stringify({
                    action: 'subscribe',
                    pair: activePair
                }));
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                // Handle different message types
                switch (data.type) {
                    case 'price_update':
                        // Update current price display
                        document.querySelector('.current-price').textContent = 
                            `${data.price} <span class="text-muted">USDC</span>`;
                        
                        // Update price change
                        const priceChangeElem = document.querySelector('.price-change');
                        priceChangeElem.textContent = `${Math.abs(data.change).toFixed(2)}%`;
                        priceChangeElem.className = 'price-change';
                        if (data.change >= 0) {
                            priceChangeElem.classList.add('green-text');
                            priceChangeElem.innerHTML += '<i class="fas fa-caret-up"></i>';
                        } else {
                            priceChangeElem.classList.add('red-text');
                            priceChangeElem.innerHTML += '<i class="fas fa-caret-down"></i>';
                        }
                        
                        // Add new data point to chart
                        if (priceChart && priceChart.data && priceChart.data.datasets[0]) {
                            priceChart.data.labels.push(new Date());
                            priceChart.data.datasets[0].data.push(data.price);
                            
                            // Remove oldest data point if we have more than 30
                            if (priceChart.data.labels.length > 30) {
                                priceChart.data.labels.shift();
                                priceChart.data.datasets[0].data.shift();
                            }
                            
                            priceChart.update();
                        }
                        break;
                        
                    case 'orderbook_update':
                        // Update sell orders
                        const sellOrdersHtml = data.sell_orders.map(order => `
                            <tr class="orderbook-row sell-order" data-price="${order.price}" data-amount="${order.amount}">
                                <td class="red-text">${order.price}</td>
                                <td>${order.amount}</td>
                                <td>${order.total}</td>
                            </tr>
                        `).join('');
                        document.getElementById('sellOrders').innerHTML = sellOrdersHtml;
                        
                        // Update buy orders
                        const buyOrdersHtml = data.buy_orders.map(order => `
                            <tr class="orderbook-row buy-order" data-price="${order.price}" data-amount="${order.amount}">
                                <td class="green-text">${order.price}</td>
                                <td>${order.amount}</td>
                                <td>${order.total}</td>
                            </tr>
                        `).join('');
                        document.getElementById('buyOrders').innerHTML = buyOrdersHtml;
                        
                        // Reattach click handlers to new rows
                        document.querySelectorAll('.orderbook-row').forEach(row => {
                            row.addEventListener('click', function() {
                                const price = this.dataset.price;
                                const amount = this.dataset.amount;
                                
                                if (this.classList.contains('sell-order')) {
                                    buyPrice.value = price;
                                    buyAmount.value = amount;
                                    updateBuyTotal();
                                    document.getElementById('buy-tab').click();
                                } else if (this.classList.contains('buy-order')) {
                                    sellPrice.value = price;
                                    sellAmount.value = amount;
                                    updateSellTotal();
                                    document.getElementById('sell-tab').click();
                                }
                            });
                        });
                        break;
                        
                    case 'trade':
                        // Add new trade to the recent trades table
                        const tradeRow = document.createElement('tr');
                        tradeRow.className = `trade-history-item ${data.trade.type}`;
                        tradeRow.innerHTML = `
                            <td>${data.trade.time}</td>
                            <td class="${data.trade.type === 'buy' ? 'green-text' : 'red-text'}">
                                ${data.trade.type.toUpperCase()}
                            </td>
                            <td>${data.trade.price}</td>
                            <td>${data.trade.amount}</td>
                            <td>${data.trade.total}</td>
                        `;
                        
                        // Add new row to the top of the table
                        const tradeTable = document.querySelector('.trade-history table tbody');
                        tradeTable.insertBefore(tradeRow, tradeTable.firstChild);
                        
                        // Remove the last row if we have too many
                        if (tradeTable.children.length > 50) {
                            tradeTable.removeChild(tradeTable.lastChild);
                        }
                        break;
                        
                    case 'balance_update':
                        // Update available balances
                        document.getElementById('buyAvailable').textContent = data.quote_balance;
                        document.getElementById('sellAvailable').textContent = data.base_balance;
                        break;
                        
                    case 'order_update':
                        // Refresh the page to show updated orders
                        // In a production app, we'd update just the orders section
                        if (data.user_id === '{{ user_id|default("") }}') {
                            location.reload();
                        }
                        break;
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocket connection closed');
                // Try to reconnect after 5 seconds
                setTimeout(setupWebSocket, 5000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                ws.close();
            };
        }
        
        // Initialize WebSocket
        setupWebSocket();
        
        // Market search functionality
        document.getElementById('marketSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            document.querySelectorAll('#marketPairs .market-pair').forEach(pair => {
                const pairText = pair.textContent.toLowerCase();
                if (pairText.includes(searchTerm)) {
                    pair.style.display = '';
                } else {
                    pair.style.display = 'none';
                }
            });
        });
        
        // Market pair selection
        document.querySelectorAll('#marketPairs .market-pair').forEach(pair => {
            pair.addEventListener('click', function() {
                const pairSymbol = this.dataset.pair;
                window.location.href = `/dex?pair=${pairSymbol}`;
            });
        });
        
        // Time period selection for chart
        document.querySelectorAll('[data-time]').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('[data-time]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update chart data - in a real app, this would fetch new data
                const timePeriod = this.dataset.time;
                console.log(`Changing chart to ${timePeriod} timeframe`);
                // Placeholder for actual implementation
            });
        });
        
        // Chart type selection
        document.querySelectorAll('[data-chart]').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                document.querySelectorAll('[data-chart]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update chart type - in a real app, this would change the chart
                const chartType = this.dataset.chart;
                console.log(`Changing chart type to ${chartType}`);
                // Placeholder for actual implementation
            });
        });
    });
</script>
{% endblock %}
